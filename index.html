// Cloudflare Worker AI pro CinkAI - OPRAVENÁ VERZE
export default {
  async fetch(request, env) {
    // Povol CORS
    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type',
    };

    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: corsHeaders });
    }

    // Jen POST requesty
    if (request.method !== 'POST') {
      return new Response(JSON.stringify({ error: 'Pouze POST requesty' }), {
        status: 405,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      });
    }

    try {
      const { message } = await request.json();
      
      if (!message) {
        return new Response(JSON.stringify({ error: 'Žádná zpráva' }), {
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        });
      }

      console.log('Přijata zpráva:', message);
      
      // POUŽITÍ CLOUDFLARE AI
      const aiResponse = await env.AI.run('@cf/meta/llama-2-7b-chat-int8', {
        messages: [
          {
            role: "system",
            content: `Jsi CinkAI - přátelský český AI asistent. Odpovídej stručně a přátelsky v češtině. 
                    Pokud se tě zeptají na něco co nevíš, řekni že se to naučíš. 
                    Buď užitečný a nápomocný. Používej emoji pro lepší čitelnost.`
          },
          {
            role: "user",
            content: message
          }
        ],
        max_tokens: 500
      });

      console.log('AI odpověď:', aiResponse);

      return new Response(JSON.stringify({ 
        reply: aiResponse.response || "Omlouvám se, nemohu nyní odpovědět." 
      }), {
        headers: { 
          ...corsHeaders,
          'Content-Type': 'application/json'
        },
      });

    } catch (error) {
      console.error('Chyba:', error);
      return new Response(JSON.stringify({ 
        error: 'Chyba serveru',
        reply: 'Omlouvám se, došlo k chybě. Zkus to prosím znovu.'
      }), {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      });
    }
  }
};
